/* This pipeline requires the following plugins:
     Git: https://plugins.jenkins.io/git/
     Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
     JUnit: https://plugins.jenkins.io/junit/
     Allure: https://plugins.jenkins.io/allure-jenkins-plugin/
     Docker Pipeline: https://plugins.jenkins.io/docker-workflow/
*/

pipeline {
    
    agent any

    stages {

        stage('build') {
            
            steps {
                // Get some code from a GitHub repository
                git 'https://github.com/SilberWitch/Sybil.git'
                // Make sure dependencies are installed
                sh 'composer install'
            }
        }

        stage('linter') {
            
            steps {
                // run the PHP linter
                sh 'find . -wholename "./src/*.php" -print0 | xargs -0 -n1 php -l'
            }
        }

        stage('test') {
            
            steps {
                // run the PHP unit tests and return test coverage statistics
                sh './vendor/bin/phpunit --coverage-html src/tests/coverage'
            }
        }

        stage('report') {
            
            steps {
                // run the PHP unit tests
                sh 'allure generate --clean'
            }
        }

    }

    post {
        always {
                // actions that take place every time
            }
        success {
                // actions that take place upon success
            }
        failure {
                //actions that take place upon failure
            }
    }
}
