/* This pipeline requires the following plugins:
     Git: https://plugins.jenkins.io/git/
     Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
     JUnit: https://plugins.jenkins.io/junit/
     Allure: https://plugins.jenkins.io/allure-jenkins-plugin/
     Docker Pipeline: https://plugins.jenkins.io/docker-workflow/
*/

pipeline {
    
    agent any

    stages {

        stage('build') {
            
            steps {
                // Make sure dependencies are installed
                sh 'composer install'
                // run the PHP linter
                sh 'find . -wholename "./src/*.php" -print0 | xargs -0 -n1 php -l'
            }
        }

        stage('test') {
            
            steps {
                // run the PHP unit tests and return test coverage statistics
                sh './vendor/bin/phpunit --coverage-html src/tests/coverage --log-junit testresult.xml'
            }
        }

    }

    post {
        always {
                allure includeProperties:
                     false,
                     jdk: '',
                     results: [[path: 'allure-results']]
            }
    }
}